<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>事故分類地圖</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <style>
    #map {
      height: 100vh;
      width: 100%;
    }
    #filterPanel {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0px 0px 8px rgba(0,0,0,0.3);
      font-size: 18px;
    }
    #filterPanel select {
      margin: 4px 0;
      font-size: 18px;
      padding: 4px 12px;
      border-radius: 5px;
    }
  </style>
</head>
<body>

<!-- 篩選器群組 -->
<div id="filterPanel">
  <label>
    事故類別：
    <select id="typeFilter">
      <option value="全部">全部</option>
      <option value="A1">A1</option>
      <option value="A2">A2</option>
    </select>
  </label>
  <br>
  <label>
    時段：
    <select id="timeFilter">
      <option value="全部">全部時段</option>
      <option value="00:00-06:00">00:00 - 06:00</option>
      <option value="06:00-12:00">06:00 - 12:00</option>
      <option value="12:00-13:00">12:00 - 13:00</option>
      <option value="13:00-14:00">13:00 - 14:00</option>
      <option value="14:00-15:00">14:00 - 15:00</option>
      <option value="15:00-18:00">15:00 - 18:00</option>
      <option value="18:00-24:00">18:00 - 24:00</option>
    </select>
  </label>
  <br>
  <label>
    年分：
    <select id="yearFilter">
      <option value="全部">全部年份</option>
      <!-- 年分自動產生 -->
    </select>
  </label>
</div>

<div id="map"></div>

<!-- 外掛JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

<script>
var map = L.map('map').setView([23.5, 121], 8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

var markers = L.markerClusterGroup();
var data = [];

// AM/PM 時間字串轉 24小時（回傳 "HH:MM"）
function convertTo24Hour(str) {
  if (!str) return "";
  str = str.trim();
  var parts = str.match(/^(\d{1,2}):(\d{2})\s?(AM|PM)$/i);
  if (!parts) return "";
  var hour = parseInt(parts[1], 10);
  var minute = parseInt(parts[2], 10);
  var ampm = parts[3].toUpperCase();
  if (ampm === "PM" && hour !== 12) hour += 12;
  if (ampm === "AM" && hour === 12) hour = 0;
  return (hour < 10 ? "0" : "") + hour + ":" + (minute < 10 ? "0" : "") + minute;
}

// 判斷時間是否落在區段內
function timeInRange(accidentTime, rangeStr) {
  if (rangeStr === "全部") return true;
  var accident24 = convertTo24Hour(accidentTime);
  if (!accident24) return false;
  var [start, end] = rangeStr.split('-');
  start = start.trim();
  end = end.trim();
  // 超過午夜的區段（例如 18:00-06:00）：
  if (end < start) {
    return (accident24 >= start || accident24 < end);
  }
  return (accident24 >= start && accident24 < end);
}

function updateMarkers() {
  var redIcon = new L.Icon({
    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
    shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
    iconSize: [25, 41],
    iconAnchor: [12, 41],
    popupAnchor: [1, -34],
    shadowSize: [41, 41]
  });
  var orangeIcon = new L.Icon({
    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-orange.png',
    shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
    iconSize: [25, 41],
    iconAnchor: [12, 41],
    popupAnchor: [1, -34],
    shadowSize: [41, 41]
  });

  markers.clearLayers();

  var selectedType = document.getElementById('typeFilter').value;
  var selectedTime = document.getElementById('timeFilter').value;
  var selectedYear = document.getElementById('yearFilter').value;

  data.forEach(function(d) {
    var lat = parseFloat(d["緯度"]);
    var lng = parseFloat(d["經度"]);
    var type = d["事故類別"];
    var time = d["時間"];
    var year = d["年"];

    var typeMatch = (selectedType === "全部" || type === selectedType);
    var timeMatch = timeInRange(time, selectedTime);
    var yearMatch = (selectedYear === "全部" || year === selectedYear);

    if (!isNaN(lat) && !isNaN(lng) && typeMatch && timeMatch && yearMatch) {
      // 先根據事故類別設定 icon
      var markerIcon = null;
      if (type === "A1") {
        markerIcon = redIcon;
      } else if (type === "A2") {
        markerIcon = orangeIcon;
      } else {
        markerIcon = L.icon({
          iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
          shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
          iconSize: [25, 41],
          iconAnchor: [12, 41],
          popupAnchor: [1, -34],
          shadowSize: [41, 41]
        });
      }

      var marker = L.marker([lat, lng], {icon: markerIcon})
        .bindPopup(
          Object.keys(d).map(function(key) {
            return key + "：" + d[key];
          }).join("<br>")
        );
      markers.addLayer(marker);
    }
  });

  map.addLayer(markers);
}

document.getElementById('typeFilter').addEventListener('change', updateMarkers);
document.getElementById('timeFilter').addEventListener('change', updateMarkers);
document.getElementById('yearFilter').addEventListener('change', updateMarkers);

// 載入CSV並自動產生年分選單
Papa.parse("雲林縣A1A2cvs.csv", {
  download: true,
  header: true,
  complete: function(results) {
    data = results.data;

    // 產生所有年分選項
    var years = {};
    data.forEach(function(d){
      var year = d["年"];
      if(year) years[year] = true;
    });
    var yearFilter = document.getElementById('yearFilter');
    yearFilter.innerHTML = '<option value="全部">全部年份</option>';
    Object.keys(years).sort().forEach(function(year){
      var option = document.createElement('option');
      option.value = year;
      option.text = year;
      yearFilter.appendChild(option);
    });

    updateMarkers();
  }
});
</script>

</body>
</html>
